<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #ecf0f1;
            --card-color: #ffffff;
            --text-color: #34495e;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .app-container {
            display: flex;
            gap: 30px;
        }
        .form-container, .preview-container {
            flex: 1;
            background-color: var(--card-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: all 0.3s ease;
        }
        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        .flashcard-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="file"] {
            margin-top: 5px;
        }
        button {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #generateFromPython {
            background-color: var(--secondary-color);
        }
        #generateFromPython:hover {
            background-color: #27ae60;
        }
        .flashcard {
            background-color: var(--card-color);
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .flashcard:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .flashcard-image {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
            border-radius: 4px;
        }
        #pythonCode {
            width: 100%;
            height: 150px;
            font-family: monospace;
            resize: vertical;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Flashcard Creator</h1>
        
        <div class="app-container">
            <div class="form-container">
                <h2>Create Flashcards</h2>
                <form id="flashcardForm" class="flashcard-form">
                    <input type="text" id="front" placeholder="Front of the card" required>
                    <input type="file" id="image" accept="image/*">
                    <textarea id="back" rows="3" placeholder="Back of the card" required></textarea>
                    <button type="submit">Add Flashcard</button>
                </form>
                
                <h2>Generate from Python</h2>
                <textarea id="pythonCode" placeholder="Enter Python code to generate flashcards. Use the format: flashcards = [{'front': 'Front text', 'back': 'Back text'}, ...]"></textarea>
                <button id="generateFromPython">Generate from Python</button>
            </div>
            
            <div class="preview-container">
                <h2>Your Flashcards</h2>
                <div class="export-buttons">
                    <button id="exportBtn">Export to CSV</button>
                    <button id="exportAnkiBtn">Export to Anki</button>
                </div>
                <div id="flashcardList"></div>
            </div>
        </div>
    </div>

    <script>
        let flashcards = [];

        document.getElementById('flashcardForm').addEventListener('submit', addFlashcard);
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        document.getElementById('exportAnkiBtn').addEventListener('click', exportToAnki);
        document.getElementById('generateFromPython').addEventListener('click', generateFromPython);

        function addFlashcard(e) {
            e.preventDefault();
            const front = document.getElementById('front').value;
            const back = document.getElementById('back').value;
            const imageFile = document.getElementById('image').files[0];
            
            if (front && back) {
                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        flashcards.push({front, back, image: event.target.result, imageName: imageFile.name});
                        updateFlashcardList();
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    flashcards.push({front, back, image: null, imageName: null});
                    updateFlashcardList();
                }
                document.getElementById('flashcardForm').reset();
            } else {
                alert('Please fill in both front and back of the card.');
            }
        }

        function updateFlashcardList() {
            const list = document.getElementById('flashcardList');
            list.innerHTML = '';
            flashcards.forEach((card, index) => {
                let imageHtml = card.image ? `<img src="${card.image}" class="flashcard-image" alt="Flashcard image">` : '';
                list.innerHTML += `
                    <div class="flashcard">
                        <h3>Flashcard ${index + 1}</h3>
                        <p><strong>Front:</strong> ${card.front}</p>
                        ${imageHtml}
                        <p><strong>Back:</strong> ${card.back}</p>
                    </div>
                `;
            });
        }

        function generateFromPython() {
            const pythonCode = document.getElementById('pythonCode').value;
            try {
                const parsedCode = pythonCode.match(/flashcards\s*=\s*(\[.*\])/s);
                if (parsedCode) {
                    const flashcardsData = JSON.parse(parsedCode[1].replace(/'/g, '"'));
                    flashcards = flashcards.concat(flashcardsData);
                    updateFlashcardList();
                    alert(`${flashcardsData.length} flashcards generated from Python code.`);
                } else {
                    alert('Invalid Python code format. Please use the format: flashcards = [{"front": "Front text", "back": "Back text"}, ...]');
                }
            } catch (error) {
                alert('Error parsing Python code. Please check your syntax.');
                console.error(error);
            }
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            flashcards.forEach(card => {
                let frontContent = card.front.replace(/,/g, "");
                if (card.image) {
                    frontContent += ` [Image included]`;
                }
                csvContent += `${frontContent},${card.back.replace(/,/g, "")}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "flashcards.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportToAnki() {
            const zip = new JSZip();
            let mediaFiles = {};
            let mediaCounter = 0;

            // Initialize SQL.js
            const SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
            });

            // Create a new database
            const db = new SQL.Database();

            // Create tables
            db.run(`
                CREATE TABLE col (
                    id              integer primary key,
                    crt             integer not null,
                    mod             integer not null,
                    scm             integer not null,
                    ver             integer not null,
                    dty             integer not null,
                    usn             integer not null,
                    ls              integer not null,
                    conf            text not null,
                    models          text not null,
                    decks           text not null,
                    dconf           text not null,
                    tags            text not null
                );
                CREATE TABLE notes (
                    id              integer primary key,
                    guid            text not null,
                    mid             integer not null,
                    mod             integer not null,
                    usn             integer not null,
                    tags            text not null,
                    flds            text not null,
                    sfld            integer not null,
                    csum            integer not null,
                    flags           integer not null,
                    data            text not null
                );
                CREATE TABLE cards (
                    id              integer primary key,
                    nid             integer not null,
                    did             integer not null,
                    ord             integer not null,
                    mod             integer not null,
                    usn             integer not null,
                    type            integer not null,
                    queue           integer not null,
                    due             integer not null,
                    ivl             integer not null,
                    factor          integer not null,
                    reps            integer not null,
                    lapses          integer not null,
                    left            integer not null,
                    odue            integer not null,
                    odid            integer not null,
                    flags           integer not null,
                    data            text not null
                );
            `);

            // Insert a row into the 'col' table (required by Anki)
            const now = Math.floor(Date.now() / 1000);
            db.run(`
                INSERT INTO col VALUES(
                    1, 
                    ${now}, 
                    ${now}, 
                    11, 
                    11, 
                    0, 
                    0, 
                    0, 
                    '{}', 
                    '{"1": {"vers": [], "name": "Basic", "tags": [], "did": 1, "usn": -1, "req": [[0, "all", [0]]], "flds": [{"name": "Front", "media": [], "sticky": false, "rtl": false, "ord": 0, "font": "Arial", "size": 20}, {"name": "Back", "media": [], "sticky": false, "rtl": false, "ord": 1, "font": "Arial", "size": 20}], "sortf": 0, "latexPre": "\\\\documentclass[12pt]{article}\n\\\\special{papersize=3in,5in}\n\\\\usepackage[utf8]{inputenc}\n\\\\usepackage{amssymb,amsmath}\n\\\\pagestyle{empty}\n\\\\setlength{\\\\parindent}{0in}\n\\\\begin{document}\n", "tmpls": [{"name": "Card 1", "qfmt": "{{Front}}", "did": null, "bafmt": "", "afmt": "{{FrontSide}}\\n\\n<hr id=answer>\\n\\n{{Back}}", "ord": 0, "bqfmt": ""}], "latexPost": "\\\\end{document}", "type": 0, "id": 1, "css": ".card {\\n font-family: arial;\\n font-size: 20px;\\n text-align: center;\\n color: black;\\n background-color: white;\\n}\\n", "mod": 1636144369}}',
                    '{"1": {"desc": "", "name": "Default", "extendRev": 50, "usn": 0, "collapsed": false, "newToday": [0, 0], "timeToday": [0, 0], "dyn": 0, "extendNew": 10, "conf": 1, "revToday": [0, 0], "lrnToday": [0, 0], "id": 1, "mod": 1636144369}}',
                    '{"1": {"name": "Default", "new": {"delays": [1, 10], "ints": [1, 4, 7], "initialFactor": 2500, "separate": true, "order": 1, "perDay": 20, "bury": false}, "lapse": {"delays": [10], "mult": 0, "minInt": 1, "leechFails": 8, "leechAction": 0}, "rev": {"perDay": 200, "ease4": 1.3, "fuzz": 0.05, "minSpace": 1, "ivlFct": 1, "maxIvl": 36500, "bury": false, "earlyStart": 20}, "maxTaken": 60, "timer": 0, "autoplay": true, "replayq": true, "mod": 0, "usn": 0}}',
                    '{}'
                )
            `);

            // Add flashcards to the database
            flashcards.forEach((card, index) => {
                const nid = Date.now() - index; // Use timestamp as note ID
                const guid = `${nid}:${Math.random().toString(36).substring(2, 15)}`; // Generate a unique GUID

                let frontContent = card.front;
                if (card.image) {
                    mediaCounter++;
                    const fileName = `image${mediaCounter}${getFileExtension(card.imageName
