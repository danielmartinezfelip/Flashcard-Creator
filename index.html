<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- ... (previous CSS styles remain the same) ... -->
</head>
<body>
    <!-- ... (previous HTML structure remains the same) ... -->

    <script>
        // ... (previous JavaScript functions remain the same) ...

        function exportToAnki() {
            const zip = new JSZip();
            let mediaFiles = {};
            let mediaCounter = 0;

            // Create collection.anki2 file (SQLite database, we'll use a minimal structure)
            const collectionSql = `
            CREATE TABLE cards (
                id INTEGER PRIMARY KEY,
                nid INTEGER NOT NULL,
                did INTEGER NOT NULL,
                ord INTEGER NOT NULL,
                mod INTEGER NOT NULL,
                usn INTEGER NOT NULL,
                type INTEGER NOT NULL,
                queue INTEGER NOT NULL,
                due INTEGER NOT NULL,
                ivl INTEGER NOT NULL,
                factor INTEGER NOT NULL,
                reps INTEGER NOT NULL,
                lapses INTEGER NOT NULL,
                left INTEGER NOT NULL,
                odue INTEGER NOT NULL,
                odid INTEGER NOT NULL,
                flags INTEGER NOT NULL,
                data TEXT NOT NULL
            );
            CREATE TABLE notes (
                id INTEGER PRIMARY KEY,
                guid TEXT NOT NULL,
                mid INTEGER NOT NULL,
                mod INTEGER NOT NULL,
                usn INTEGER NOT NULL,
                tags TEXT NOT NULL,
                flds TEXT NOT NULL,
                sfld INTEGER NOT NULL,
                csum INTEGER NOT NULL,
                flags INTEGER NOT NULL,
                data TEXT NOT NULL
            );
            `;
            zip.file("collection.anki2", collectionSql);

            // Create cards content
            let cardsContent = "";
            flashcards.forEach((card, index) => {
                let frontContent = card.front;
                if (card.image) {
                    mediaCounter++;
                    const fileName = `image${mediaCounter}${getFileExtension(card.imageName)}`;
                    mediaFiles[mediaCounter] = fileName;
                    zip.file(fileName, card.image.split(',')[1], {base64: true});
                    frontContent += `<br><img src="${fileName}">`;
                }
                cardsContent += `${frontContent}\t${card.back}\n`;
            });

            // Add cards file to zip
            zip.file("notes.txt", cardsContent);

            // Create and add media file to zip
            let mediaContent = JSON.stringify(mediaFiles);
            zip.file("media", mediaContent);

            // Create minimal deck structure
            const deckStructure = {
                "1": {
                    "desc": "",
                    "name": "Imported Deck",
                    "extendRev": 50,
                    "usn": 0,
                    "collapsed": false,
                    "newToday": [0, 0],
                    "timeToday": [0, 0],
                    "dyn": 0,
                    "extendNew": 10,
                    "conf": 1,
                    "revToday": [0, 0],
                    "lrnToday": [0, 0],
                    "id": 1,
                    "mod": 1599345417
                }
            };
            zip.file("deck", JSON.stringify(deckStructure));

            // Generate and download the zip file
            zip.generateAsync({type:"blob"})
            .then(function(content) {
                saveAs(content, "anki_flashcards.apkg");
            });
        }

        function getFileExtension(filename) {
            return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2);
        }
    </script>
</body>
</html>
